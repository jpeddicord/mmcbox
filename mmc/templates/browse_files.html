{% extends 'layout.html' %}

{% block head %}
{{ super() }}
<script src="{{ url_for('static', filename='jquery.iframe-transport.js') }}"></script>
<script src="{{ url_for('static', filename='jquery.fileupload.js') }}"></script>
<link rel="stylesheet" media="screen" href="{{ url_for('static', filename='browser.css') }}" />

<script type="text/javascript">
	$(function() {
		// tooltips
		$('button').twipsy({placement: 'right'});

		// button actions
		$('#newfile').click(function(){
			var name = prompt("What do you want to name the file?");
			if (name != null && name != 'null' && name != '') {
				$.post('{{ url_for('new_file', domain=domain) }}',
					{'path': '{{ path }}', 'filename': name},
					function() {
						window.location.reload();
					}
				);
			}
		});
		$('#newfolder').click(function(){
			var name = prompt("What do you want to name the folder?");
			if (name != null && name != 'null' && name != '') {
				$.post('{{ url_for('new_folder', domain=domain) }}',
					{'path': '{{ path }}', 'filename': name},
					function() {
						window.location.reload();
					}
				);
			}
		});
		$('#upload').click(function(){
		});

		// upload magic
		$('#fileupload').fileupload({
			dataType: 'json',
			url: '{{ url_for('upload_file', domain=domain) }}',
			formData: {'path': '{{ path }}'},
			done: function(e, data) {
				window.location.reload();
			},
			error: function(jqXHR, textStatus, errorThrown) {
				alert("Upload failed. It may be too large, or not an acceptable type.");
			}
		});

		// rename and delete
		$('.rename a').click(function(){
			var original = $(this).attr('data-path');
			var rename = prompt("New name:");
			if (rename != null && rename != 'null' && rename != '') {
				$.post('{{ url_for('rename_file', domain=domain) }}',
				{'path': '{{ path }}', 'original': original, 'rename': rename},
					function() {
						window.location.reload();
					}
				);
			}
		});
		$('.delete a').click(function(){
			var file = $(this).attr('data-path');
			if (confirm("Trash this file?")) {
				$.post('{{ url_for('delete_file', domain=domain) }}',
				{'file': file },
					function() {
						window.location.reload();
					}
				);
			}
		});
	});
</script>
{% endblock %}

{% block content %}

<div class="well">
	<button id="newfile" class="btn info primary">New File</button>
	<button id="newfolder" class="btn">New Folder</button>
	<!--<button id="upload" class="btn" title="You can also upload files by dragging them onto the page!">Upload
	</button>-->
	<span style="margin-left: 10px;">Upload: <input id="fileupload" type="file" name="files[]" multiple></span>
</div>

<ul id="browser">
	{% if path %}
	<li class="folder">
		<a href="../" class="ui-button-content"><em>^ Up..</em></a>
	</li>
	{% endif %}

	{% for d in dirs %}
	<li class="folder">
		<!--<ul>
			<li class="delete">delete</li>
			<li class="rename">rename</li>
		</ul>-->
		<a href="{{ d }}/" class="ui-button-content">{{ d }}/</a>
	</li>
	{% endfor %}

	{% for f in files %}
	<li class="file">
		<ul>
			<li class="delete"><a data-path="{{ join(path, f) }}" href="#">delete</a></li>
			<li class="rename"><a data-path="{{ join(path, f) }}" href="#">rename</a></li>
		</ul>
		<strong>{{ f }}</strong>
		<a href="//{{ domain }}/{{ join(path, f) }}" target="_blank">view</a>
		<a href="{{ url_for('edit_file', domain=domain, path=join(path, f)) }}" target="_blank">edit</a>
	</li>
	{% endfor %}
</ul>

{% endblock %}
